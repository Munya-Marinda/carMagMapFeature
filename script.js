//
//
// Dummy Data

const RegionData = [
  {
    regionName: "Eastern Cape",
    regionLocation: { lat: -32.0869448, lng: 24.1658452 },
    iconURL: "ec.png",
    dealerships: [
      {
        dealerName: "Auto Pedigree East London",
        location: { lat: -32.9588026, lng: 27.9326508 },
        totalCars: 14,
        logoURL: "./assets/dealership_assets/circle/auto_pedigree.png",
      },
      {
        dealerName: "Auto Pedigree Eastern Cape",
        location: { lat: -32.7656184, lng: 26.0495569 },
        totalCars: 164,
        logoURL: "./assets/dealership_assets/circle/auto_pedigree.png",
      },
      {
        dealerName: "Izuzu Meyers Motors King Williams Town",
        location: { lat: -32.9186817, lng: 27.5163521 },
        totalCars: 21,
        logoURL: "./assets/dealership_assets/circle/izuzu_meyers_car.png",
      },
      {
        dealerName: "Meyers Car Bazar",
        location: { lat: -33.0138502, lng: 27.9027218 },
        totalCars: 17,
        logoURL: "./assets/dealership_assets/circle/izuzu_meyers_car.png",
      },
      {
        dealerName: "Ronnies Motors",
        location: { lat: -33.0138305, lng: 27.8346931 },
        totalCars: 10,
        logoURL: "./assets/dealership_assets/circle/ronnies_motors.png",
      },
    ],
  },
  {
    regionName: "Free State",
    regionLocation: { lat: -28.6743815, lng: 25.9448766 },
    iconURL: "fc.png",
    dealerships: [
      {
        dealerName: "Auto Pedigree Bloemfontein Oliver Tambo",
        location: { lat: -29.1247446, lng: 26.2173738 },
        totalCars: 14,
        logoURL: "./assets/dealership_assets/circle/auto_pedigree.png",
      },
      {
        dealerName: "Auto Pedigree Bloemfontein Zastro",
        location: { lat: -29.113348, lng: 26.2181539 },
        totalCars: 15,
        logoURL: "./assets/dealership_assets/circle/auto_pedigree.png",
      },
      {
        dealerName: "Auto Pedigree Qwa-Qwa",
        location: { lat: -28.531306, lng: 28.829376 },
        totalCars: 12,
        logoURL: "./assets/dealership_assets/circle/auto_pedigree.png",
      },
    ],
  },
  {
    regionName: "Gauteng",
    regionLocation: { lat: -26.0144053, lng: 27.5669771 },
    iconURL: "gp.png",
    dealerships: [
      {
        dealerName: "Autocad Cars",
        location: { lat: -26.0957812, lng: 28.0028578 },
        totalCars: 295,
        logoURL: "./assets/dealership_assets/circle/standard_car_icon.png",
      },
      {
        dealerName: "Auto Investments Centurion",
        location: { lat: -26.6793108, lng: 27.4983813 },
        totalCars: 157,
        logoURL: "./assets/dealership_assets/circle/standard_car_icon.png",
      },
    ],
  },
  {
    regionName: "KwaZulu-Natal",
    regionLocation: { lat: -28.9378436, lng: 29.7612388 },
    iconURL: "kzn.png",
    dealerships: [
      {
        dealerName: "Halfway Ford Waterfall",
        location: { lat: -29.7509046, lng: 30.8116776 },
        totalCars: 23,
        logoURL: "./assets/dealership_assets/circle/standard_car_icon.png",
      },
    ],
  },
  {
    regionName: "Limpopo",
    regionLocation: { lat: -23.7675464, lng: 28.0246553 },
    iconURL: "lp.png",
    dealerships: [
      {
        dealerName: "Auto Pedigree Burgersfort",
        location: { lat: -24.684232, lng: 30.334904 },
        totalCars: 10,
        logoURL: "./assets/dealership_assets/circle/standard_car_icon.png",
      },
      {
        dealerName: "Auto Pedigree Groblersdal",
        location: { lat: -25.171794350469916, lng: 29.391719878212463 },
        totalCars: 15,
        logoURL: "./assets/dealership_assets/circle/auto_pedigree.png",
      },
      {
        dealerName: "Auto Pedigree Polokwane South",
        location: { lat: -23.9157526, lng: 29.4423274 },
        totalCars: 15,
        logoURL: "./assets/dealership_assets/circle/auto_pedigree.png",
      },
    ],
  },
  {
    regionName: "Mpumalanga",
    regionLocation: { lat: -25.7369283, lng: 29.0175029 },
    iconURL: "mp.png",
    dealerships: [
      {
        dealerName: "Auto Italia",
        location: { lat: -25.7720133, lng: 29.4715153 },
        totalCars: 18,
        logoURL: "./assets/dealership_assets/circle/standard_car_icon.png",
      },
      {
        dealerName: "Auto Pedigree Ermelo",
        location: { lat: -26.5373093, lng: 29.9875623 },
        totalCars: 11,
        logoURL: "./assets/dealership_assets/circle/auto_pedigree.png",
      },
    ],
  },
  {
    regionName: "Northern Cape",
    regionLocation: { lat: -29.67818, lng: 21.265989 },
    iconURL: "nc.png",
    dealerships: [
      {
        dealerName: "Auto Pedigree Kimberley",
        location: { lat: -26.5373093, lng: 29.9875623 },
        totalCars: 12,
        logoURL: "./assets/dealership_assets/circle/auto_pedigree.png",
      },
    ],
  },
  {
    regionName: "North West",
    regionLocation: { lat: -26.3681227, lng: 24.342673 },
    iconURL: "nw.png",
    dealerships: [
      {
        dealerName: "Auto Pedigree Brits",
        location: { lat: -25.6300674, lng: 27.7787409 },
        totalCars: 19,
        logoURL: "./assets/dealership_assets/circle/auto_pedigree.png",
      },
    ],
  },
  {
    regionName: "Western Cape",
    regionLocation: { lat: -32.8847716, lng: 19.7016556 },
    iconURL: "wc.png",
    dealerships: [
      {
        dealerName: "Alterior Auto",
        location: { lat: -33.9067444, lng: 18.580001 },
        totalCars: 11,
        logoURL: "./assets/dealership_assets/circle/standard_car_icon.png",
      },
      {
        dealerName: "Auto Pedigree Bellville",
        location: { lat: -33.9023769, lng: 18.6072502 },
        totalCars: 10,
        logoURL: "./assets/dealership_assets/circle/auto_pedigree.png",
      },
    ],
  },
];

//
//
//
// Dummy Data ends
//
//
//
//
//
//
//
//

// Class to manage map functions
class DealershipMap {
  constructor(region_data) {
    this.RegionData = region_data; // array of region data
    this.map = null; // Google map object
    this.RegionMarkers = []; // contains array of region markers
    this.DealershipMarkers = []; // contains array of dealership markers
    this.DealershipInfoWindow = []; // contains array of infoWindows
    // stores user activity on the map
    this.MapState = {
      // user location
      userLocation: null,
      // "region_view" or "dealership_view"
      state: "region_view",
      // clicks in each new state
      num_of_clicks: 0,
      // regions opened during session
      num_of_regions_browsed: 0,
    };
  } // constructor ends

  //
  // Set of functions executed when the document loads
  docReady() {
    // ask user location
    dealershipMap.userLocation("ask");

    // send props data to create new map
    var mapProp = {
      center: new google.maps.LatLng(-28.6743815, 25.9448766),
      zoom: 6,
    };
    // create and load map
    this.loadMap(mapProp);

    // populate Region Map Markers
    this.populateRegionMapMarkers();

    // load the Province buttons
    document.getElementById("regionButtons").innerHTML =
      this.getProvinceButtons();

    // place the zoom-out-to-region button position in its parent
    var button = document.getElementById("zoomOutButton");
  } // docReady ends

  //
  // opens map region
  openMapToRegion(region_Name) {
    this.MapState.num_of_regions_browsed++;
    // array of marker locations - to reset the map window to plotted makers
    var arrMarkerLocations = [];
    // iterate through regions
    this.RegionData.forEach((region) => {
      // find matching region
      if (region.regionName === region_Name) {
        // remove region markers
        this.RegionMarkers.forEach((marker) => {
          marker.setMap(null);
          // Change map state
          this.MapState.state = "dealership_view";
          // reset clicks in view
          this.manageClicks(0); // reset to 0
        });
        // iterate through dealerships
        region.dealerships.forEach((dealership) => {
          // add to array of maker locations
          arrMarkerLocations.push(dealership.location);

          // create dealership marker
          var marker = new google.maps.Marker({
            position: dealership.location,
            map: this.map,
            title: dealership.dealerName,
            // label: dealership.totalCars.toString(),
            animation: google.maps.Animation.DROP,
          });
          // add dealership markers to array
          this.DealershipMarkers.push(marker);

          // create info window
          var infoWindow = new google.maps.InfoWindow();

          // content for the info window
          var infoWindowContent =
            ' <div id="dealershipPopup"> <img src="' +
            dealership.logoURL +
            '" alt="dealershipImage" style="width: 40px; height: 40px"  /> <div style="margin-left: 5px; width: 195px;"> <div style="padding: 5px;" > <span style="font-weight: bold; font-size: 15px">' +
            dealership.dealerName +
            '</span> </div> <div style=" display: flex; justify-content: space-between; padding-bottom: 5px; padding-left: 5px;padding-right: 5px;" > <span style="font-size: 10px; padding: 5px; border-radius: 5px; background-color: lightgray">TOTAL CARS: ' +
            dealership.totalCars.toString() +
            '</span> <span> <a href="https://www.google.com" style="" >website</a > </span> </div> </div> </div>';

          // add to array of infoWindows
          this.DealershipInfoWindow.push(infoWindow);

          // onclick() event
          marker.addListener("click", (event) => {
            // close other infoWindows
            this.DealershipInfoWindow.forEach((window) => {
              window.close();
            });

            // show clicked marker's infoWindow
            infoWindow.setContent(infoWindowContent);
            infoWindow.open(this.map, marker);
            infoWindow.focus();
          });
        });
      }
    });
    // reset view to markers if markers > 0
    if (arrMarkerLocations.length > 0) {
      this.resetBounds(arrMarkerLocations, 8, 0);
    }
  } // openMapToRegion ends

  //
  // Returns province buttons
  getProvinceButtons() {
    var innerHTML = "";

    // Iterate through list of provinces and create a button for each
    this.RegionData.forEach((region) => {
      innerHTML +=
        ' <button style="padding: 7px; margin-left:10px; border: 0px; border-radius: 10px; color: white; background-color: gray" type="button" onclick="open' +
        region.regionName.replace(/\s/g, "").replace("-", "") +
        '()">' +
        region.regionName +
        "</button>";
    });

    // Returns message if the html-template is empty
    if (innerHTML === "") {
      innerHTML = "...loading province buttons";
    }

    return innerHTML;
  } // getProvinceButtons ends

  //
  // loads map
  loadMap(mapProp) {
    this.map = new google.maps.Map(
      document.getElementById("googleMap"),
      mapProp
    );
  } // loadMap ends

  //
  // adds marker to map
  populateRegionMapMarkers() {
    // iterate through region-data and add region markers
    this.RegionData.forEach((region) => {
      // create icon object
      var regionIcon = {
        url: "./assets/region_assets/" + region.iconURL.toString(), // url,
        alt: "province: " + region.iconURL.toString(),
        scaledSize: new google.maps.Size(40, 50), // size
      };
      // create marker
      var marker = new google.maps.Marker({
        position: region.regionLocation,
        map: this.map,
        title: region.regionName,
        // label: region.regionName,
        icon: regionIcon,
        animation: google.maps.Animation.DROP,
      });
      // add marker to array of region markers
      this.RegionMarkers.push(marker);
      // onclick event of marker to open region
      marker.addListener("click", (event) => {
        this.openMapToRegion(event.domEvent.target.parentNode.title);
      });
    });
  } // populateRegionMapMarkers ends

  //
  // resets map view to mapped makers
  resetBounds(locations, zoom, panToIndex) {
    // create Google bounds object - used to set view to plotted markers
    var bounds = new google.maps.LatLngBounds();

    // if statement - if we're given more than 1 location (for zoom purpose)
    if (locations.length !== 1) {
      // iterate through locations and add them to bounds
      locations.forEach((location) => {
        bounds.extend(location);
      });
      // move map to region
      this.map.panTo(locations[panToIndex]);
      //  zoom into map
      this.map.setZoom(zoom);
    } else {
      // ...else if we're given more than on location
      bounds.extend(locations[panToIndex]);
      // move map to region
      this.map.panTo(locations[panToIndex]);
      // fit the map to bounds
      this.map.fitBounds(bounds);
      //  zoom into map
      this.map.setZoom(zoom);
    }
  } // resetBounds ends

  //
  // slide "in" or "out" the zoom-out-to-region-button
  showRegionsAnimation(type, parentID) {
    // set the parent and button container
    var parent = document.getElementById(parentID);
    var buttonContainer = document.getElementById("zoomOutButton_container");

    // get parent's width and put child against right side
    const parentMiddleX = parent.clientWidth;

    // get parent's height and calc where to place button container
    const parentMiddleY = parent.clientHeight;

    switch (type) {
      case "in":
        // move button container to parents middle
        buttonContainer.style.left =
          parentMiddleX - buttonContainer.clientWidth + "px";
        buttonContainer.style.top = parentMiddleY / 0.9 + "px";

        // set opacity of button container (for fade in effect)
        buttonContainer.style.display = "block";
        buttonContainer.style.opacity = 1;

        // id of the animation
        var slideIn_id = null;

        // value to animate
        var leftValue = parentMiddleX;

        // clear the animation - safety
        clearInterval(slideIn_id);

        // start the animation
        slideIn_id = setInterval(slideIn, 5);

        // actual animation
        function slideIn() {
          // when to stop animation
          if (leftValue < parentMiddleX * 0.9 - buttonContainer.clientWidth) {
            // stop animation
            clearInterval(slideIn_id);
          } else {
            // move in effect
            leftValue = parseInt(buttonContainer.style.left) - 5;
            buttonContainer.style.left = leftValue + "px";
            buttonContainer.style.opacity =
              parseFloat(buttonContainer.style.opacity) + 0.04;
          }
        }

        break;

      case "out":
        // set opacity of button container (for fade out effect)
        buttonContainer.style.opacity = 1;

        // id of the animation
        var slideOut_id = null;

        // value to animate
        var leftValue = parentMiddleX;

        // clear the animation - safety
        clearInterval(slideOut_id);

        // start the animation
        slideOut_id = setInterval(slideOut, 10);

        // actual animation
        function slideOut() {
          // when to stop animation
          if (leftValue > parentMiddleX) {
            // stop animation
            clearInterval(slideOut_id);
          } else {
            // move in effect
            leftValue = parseInt(buttonContainer.style.left) + 5;
            buttonContainer.style.left = leftValue + "px";
            // fade in effect
            buttonContainer.style.opacity =
              parseFloat(buttonContainer.style.opacity) - 0.04;
          }
        }

        // hide button
        buttonContainer.style.display = "none";
        buttonContainer.style.opacity = 0;

        // place region markers
        this.RegionMarkers.forEach((marker) => {
          marker.setMap(this.map);
        });

        // remove dealership-region markers
        this.DealershipMarkers.forEach((marker) => {
          marker.setMap(null);
        });

        // get lat and lng
        var locations = []; // array of locations to set the map view
        this.RegionData.forEach((region) => {
          locations.push(region.regionLocation);
        });

        // reset map view
        this.resetBounds(locations, 6, 1);

        // Change map state
        this.MapState.state = "region_view";

        // reset clicks in view
        this.manageClicks(0); // reset to 0

        break;

      default:
        break;
    }
  } // showRegionsAnimation

  //
  // reset/increment/decrement user click
  manageClicks(number) {
    // elements
    const regionViewButton = document.getElementById("zoomOutButton_container");

    // (number = 0) resets to 0
    if (number === 0) {
      this.MapState.num_of_clicks = number;
    } else {
      // incr or decr
      this.MapState.num_of_clicks += number;
    }

    // the state and number of clicks determine certain functions
    const clicks = this.MapState.num_of_clicks;
    const state = this.MapState.state;
    const region = this.MapState.num_of_regions_browsed;

    // click and state
    if (clicks === 2 && state === "dealership_view") {
      // animates in the button
      dealershipMap.showRegionsAnimation("in", "googleMapContainer");
    }

    if (
      region === 2 &&
      state === "dealership_view" &&
      regionViewButton.style.display !== "block"
    ) {
      // animates in the button
      dealershipMap.showRegionsAnimation("in", "googleMapContainer");
    }
  } // manageClicks ends

  // userLocation
  userLocation(action) {
    switch (action) {
      case "ask":
        // info window to display errors
        var infoWindow = new google.maps.InfoWindow();

        // if location was provided
        if (this.MapState.userLocation !== null) {
          // recenter map
          this.map.setCenter(this.MapState.userLocation);

          // zoom-in map
          this.map.setZoom(12);
        } else {
          // Ask user location, try HTML5 geolocation.
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              // get user position
              (position) => {
                this.MapState.userLocation = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                };

                // place info window
                infoWindow.setPosition(this.MapState.userLocation);

                // create icon object
                var userLocationIcon = {
                  url: "./assets/svg/userlocation3.svg", // url,
                  alt: "user location icon",
                  scaledSize: new google.maps.Size(40, 50), // size
                };

                // create user marker
                const userMarker = new google.maps.Marker({
                  position: this.MapState.userLocation,
                  map: this.map,
                  title: "ME",
                  icon: userLocationIcon,
                });

                userMarker.addListener("click", () => {
                  // recenter map
                  this.map.setCenter(this.MapState.userLocation);

                  // zoom-in map
                  this.map.setZoom(12);
                });

                // recenter map
                this.map.setCenter(this.MapState.userLocation);

                // zoom-in map
                this.map.setZoom(10);
              },
              () => {
                // incase of an error
                handleLocationError(true, infoWindow, this.map.getCenter());
              }
            );
          } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, infoWindow, this.map.getCenter());
          }
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
          infoWindow.setPosition(pos);
          infoWindow.setContent(
            browserHasGeolocation
              ? "Error: The Geolocation service failed."
              : "Error: Your browser doesn't support geolocation."
          );
          infoWindow.open(this.map);
        }

        break;

      default:
        break;
    }
  } // userLocation
} // Class DealershipMap ends

//
// create new Class Object
const dealershipMap = new DealershipMap(RegionData);

//
//
//
//
// function on window.load
window.onload = () => {
  dealershipMap.docReady();
};

//
//
//
//
//
//
//
//
//
//
// on-region-click() events
//

function openEasternCape() {
  dealershipMap.openMapToRegion("Eastern Cape");
}
function openFreeState() {
  dealershipMap.openMapToRegion("Free State");
}
function openGauteng() {
  dealershipMap.openMapToRegion("Gauteng");
}
function openKwaZuluNatal() {
  dealershipMap.openMapToRegion("KwaZulu-Natal");
}
function openLimpopo() {
  dealershipMap.openMapToRegion("Limpopo");
}
function openMpumalanga() {
  dealershipMap.openMapToRegion("Mpumalanga");
}
function openNorthernCape() {
  dealershipMap.openMapToRegion("Northern Cape");
}
function openNorthWest() {
  dealershipMap.openMapToRegion("North West");
}
function openWesternCape() {
  dealershipMap.openMapToRegion("Western Cape");
}

// Zoom out to region view
function ShowRegionMarkers() {
  dealershipMap.showRegionsAnimation("out", "googleMapContainer");
}

// User click count
function MapContainer() {
  dealershipMap.manageClicks(+1);
}

// User wants to give location permission
function userWantsLocation() {
  dealershipMap.userLocation("ask");
}

//
//
//
// 